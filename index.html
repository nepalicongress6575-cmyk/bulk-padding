<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bulk Image Watermark Tool</title>

    <style>
      /* ‚îÄ‚îÄ CSS Variables: Facebook-style dark & light themes ‚îÄ‚îÄ */
      :root[data-theme="dark"] {
        --bg-primary: #18191a;
        --bg-secondary: #242526;
        --bg-tertiary: #3a3b3c;
        --text-primary: #e4e6eb;
        --text-secondary: #b0b3b8;
        --accent: #2d88ff;
        --accent-hover: #1a73e8;
        --border: #3e4042;
        --input-bg: #3a3b3c;
        --input-text: #e4e6eb;
        --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        --progress-track: #3a3b3c;
        --progress-fill: #2d88ff;
        --success: #31a24c;
        --file-label-bg: #3a3b3c;
        --file-label-hover: #4e4f50;
        --overlay-bg: rgba(0, 0, 0, 0.5);
        --spinner-border: rgba(255, 255, 255, 0.15);
        --spinner-active: #2d88ff;
      }

      :root[data-theme="light"] {
        --bg-primary: #f0f2f5;
        --bg-secondary: #ffffff;
        --bg-tertiary: #f0f2f5;
        --text-primary: #050505;
        --text-secondary: #65676b;
        --accent: #1877f2;
        --accent-hover: #166fe5;
        --border: #ced0d4;
        --input-bg: #f0f2f5;
        --input-text: #050505;
        --card-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        --progress-track: #e4e6eb;
        --progress-fill: #1877f2;
        --success: #31a24c;
        --file-label-bg: #e4e6eb;
        --file-label-hover: #d8dadf;
        --overlay-bg: rgba(255, 255, 255, 0.6);
        --spinner-border: rgba(0, 0, 0, 0.1);
        --spinner-active: #1877f2;
      }

      /* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 40px 16px;
        transition:
          background 0.3s,
          color 0.3s;
      }

      /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
      .header {
        width: 100%;
        max-width: 640px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header h1 .icon {
        font-size: 28px;
      }

      /* ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ */
      .theme-toggle {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-primary);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        transition:
          background 0.2s,
          transform 0.2s;
        flex-shrink: 0;
      }

      .theme-toggle:hover {
        background: var(--file-label-hover);
        transform: scale(1.08);
      }

      /* ‚îÄ‚îÄ Card Container ‚îÄ‚îÄ */
      .container {
        width: 100%;
        max-width: 640px;
        background: var(--bg-secondary);
        padding: 28px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border);
        position: relative;
        transition:
          background 0.3s,
          box-shadow 0.3s,
          border-color 0.3s;
      }

      /* ‚îÄ‚îÄ Form Labels ‚îÄ‚îÄ */
      .form-group {
        margin-bottom: 18px;
      }

      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* ‚îÄ‚îÄ File Input ‚îÄ‚îÄ */
      .file-input-wrapper {
        position: relative;
      }

      .file-input-wrapper input[type="file"] {
        display: none;
      }

      .file-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 20px;
        border: 2px dashed var(--border);
        border-radius: 10px;
        background: var(--file-label-bg);
        color: var(--text-secondary);
        font-size: 15px;
        cursor: pointer;
        transition:
          background 0.2s,
          border-color 0.2s,
          color 0.2s;
        text-align: center;
      }

      .file-label:hover {
        background: var(--file-label-hover);
        border-color: var(--accent);
        color: var(--accent);
      }

      .file-label .upload-icon {
        font-size: 24px;
      }

      .file-count {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        display: none;
      }

      .file-count.show {
        display: block;
      }

      /* ‚îÄ‚îÄ Button ‚îÄ‚îÄ */
      .btn-process {
        width: 100%;
        padding: 14px;
        border-radius: 8px;
        border: none;
        background: var(--accent);
        color: #fff;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition:
          background 0.2s,
          opacity 0.2s,
          transform 0.1s;
      }

      .btn-process:hover:not(:disabled) {
        background: var(--accent-hover);
        transform: translateY(-1px);
      }

      .btn-process:active:not(:disabled) {
        transform: translateY(0);
      }

      .btn-process:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      .btn-process .btn-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }

      .btn-process.loading .btn-spinner {
        display: inline-block;
      }

      .btn-process.loading .btn-label {
        display: none;
      }

      .btn-process.loading .btn-loading-label {
        display: inline;
      }

      .btn-process .btn-loading-label {
        display: none;
      }

      /* ‚îÄ‚îÄ Progress Section ‚îÄ‚îÄ */
      .progress-section {
        margin-top: 20px;
        display: none;
      }

      .progress-section.show {
        display: block;
      }

      .progress-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .progress-header .progress-text {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .progress-header .progress-percent {
        font-size: 14px;
        font-weight: 700;
        color: var(--accent);
      }

      .progress-bar-track {
        width: 100%;
        height: 10px;
        background: var(--progress-track);
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), #4eaaff);
        border-radius: 999px;
        transition: width 0.35s ease;
      }

      .progress-detail {
        margin-top: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        min-height: 20px;
      }

      /* ‚îÄ‚îÄ Status Toast ‚îÄ‚îÄ */
      .toast {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        display: none;
        align-items: center;
        gap: 8px;
        animation: slideUp 0.3s ease;
      }

      .toast.show {
        display: flex;
      }

      .toast.success {
        background: rgba(49, 162, 76, 0.15);
        color: var(--success);
        border: 1px solid rgba(49, 162, 76, 0.3);
      }

      .toast.error {
        background: rgba(235, 64, 52, 0.15);
        color: #eb4034;
        border: 1px solid rgba(235, 64, 52, 0.3);
      }

      /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
      .footer {
        margin-top: 32px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
      @media (max-width: 500px) {
        .header h1 {
          font-size: 20px;
        }
        .container {
          padding: 20px;
        }
      }
    </style>
  </head>

  <body>
    <!-- Header -->
    <div class="header">
      <h1><span class="icon">üñºÔ∏è</span> Bulk Watermark Tool</h1><br><br><hr>
      <h4 style="background-color:black;color:white;padding:5px;border-radius:5px">‚ö†Ô∏è‚ö†Ô∏èNotice! Please convert HEIC(Iphone images) to <b>JPG/PNG<b> first then upload the files.‚ö†Ô∏è‚ö†Ô∏è<h4>
      <button
        class="theme-toggle"
        id="themeToggle"
        title="Toggle dark/light mode"
        onclick="toggleTheme()"
      >
        üåô
      </button>
    </div>

    <!-- Main Card -->
    <div class="container">
      <!-- File Picker -->
      <div class="form-group">
        <label>Select Images</label>
        <div class="file-input-wrapper">
          <input
            type="file"
            id="images"
            multiple
            accept="image/*,.heic,.heif,.webp,.bmp,.tiff,.tif,.avif,.raw,.dng,.cr2,.nef,.arw,.svg"
            onchange="updateFileCount()"
          />
          <div
            class="file-label"
            onclick="document.getElementById('images').click()"
          >
            <span class="upload-icon">üìÅ</span>
            <span>Click to browse or drop images here</span>
          </div>
          <div class="file-count" id="fileCount"></div>
        </div>
      </div>

      <!-- Process Button -->
      <button class="btn-process" id="processBtn" onclick="processAll()">
        <span class="btn-spinner"></span>
        <span class="btn-label">üöÄ Process & Download ZIP</span>
        <span class="btn-loading-label">Processing‚Ä¶</span>
      </button>

      <!-- Progress -->
      <div class="progress-section" id="progressSection">
        <div class="progress-header">
          <span class="progress-text" id="progressText"
            >Processing images‚Ä¶</span
          >
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <div class="progress-detail" id="progressDetail"></div>
      </div>

      <!-- Toast -->
      <div class="toast" id="toast"></div>
    </div>

    <div class="footer">Watermark images locally ‚Äî nothing is uploaded.</div>

    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- HEIC/HEIF conversion with built-in WASM decoder -->
    <script type="module">
      // Import heic2any with full dependencies
      window.heic2anyLoaded = import("https://cdn.skypack.dev/heic2any")
        .then((module) => {
          window.heic2any = module.default;
          console.log("HEIC converter loaded successfully");
        })
        .catch((err) => {
          console.error("Failed to load HEIC converter:", err);
        });
    </script>

    <script>
      const LOGO_1_PATH = "./flag.png";
      const LOGO_2_PATH = "./tree.png";

      /* ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ */
      function toggleTheme() {
        const html = document.documentElement;
        const btn = document.getElementById("themeToggle");
        if (html.getAttribute("data-theme") === "dark") {
          html.setAttribute("data-theme", "light");
          btn.textContent = "‚òÄÔ∏è";
        } else {
          html.setAttribute("data-theme", "dark");
          btn.textContent = "üåô";
        }
      }

      /* ‚îÄ‚îÄ File Count Feedback ‚îÄ‚îÄ */
      function updateFileCount() {
        const files = document.getElementById("images").files;
        const el = document.getElementById("fileCount");
        if (files.length > 0) {
          el.textContent = `‚úÖ ${files.length} image${files.length > 1 ? "s" : ""} selected`;
          el.classList.add("show");
        } else {
          el.classList.remove("show");
        }
      }

      /* ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ */
      function setLoading(isLoading) {
        const btn = document.getElementById("processBtn");
        if (isLoading) {
          btn.disabled = true;
          btn.classList.add("loading");
        } else {
          btn.disabled = false;
          btn.classList.remove("loading");
        }
      }

      function showProgress(current, total, fileName) {
        const section = document.getElementById("progressSection");
        const fill = document.getElementById("progressFill");
        const percent = document.getElementById("progressPercent");
        const detail = document.getElementById("progressDetail");
        const text = document.getElementById("progressText");

        section.classList.add("show");
        const pct = Math.round((current / total) * 100);
        fill.style.width = pct + "%";
        percent.textContent = pct + "%";
        text.textContent = `Processing images (${current}/${total})`;
        detail.textContent = `Current: ${fileName}`;
      }

      function resetProgress() {
        const fill = document.getElementById("progressFill");
        fill.style.width = "0%";
        document.getElementById("progressPercent").textContent = "0%";
        document.getElementById("progressDetail").textContent = "";
        document.getElementById("progressText").textContent =
          "Processing images‚Ä¶";
      }

      function showToast(message, type) {
        const toast = document.getElementById("toast");
        toast.className = "toast show " + type;
        toast.innerHTML = (type === "success" ? "‚úÖ " : "‚ùå ") + message;
        setTimeout(() => {
          toast.classList.remove("show");
        }, 5000);
      }

      /* ‚îÄ‚îÄ Main Processing (logic unchanged) ‚îÄ‚îÄ */
      async function processAll() {
        const imageFiles = document.getElementById("images").files;
        const text = "";
        const topPad = 400;
        const sidePad = 180;
        const bottomPad = Math.floor(sidePad * 1.5); // wider bottom border

        if (!imageFiles.length) {
          showToast("Please select images first.", "error");
          return;
        }

        setLoading(true);
        resetProgress();
        document.getElementById("progressSection").classList.add("show");

        try {
          const zip = new JSZip();

          // Load logos once
          const logo1 = await loadImage(LOGO_1_PATH);
          const logo2 = await loadImage(LOGO_2_PATH);

          let processed = 0;
          const total = imageFiles.length;

          for (const file of imageFiles) {
            showProgress(processed, total, file.name);

            // Convert HEIC/HEIF or other exotic formats to a browser-readable blob
            let readableBlob;
            try {
              readableBlob = await toReadableBlob(file);
            } catch (convErr) {
              console.error(
                `Skipping ${file.name}: could not convert ‚Äî`,
                convErr,
              );
              showToast(`Could not convert ${file.name} ‚Äî skipped.`, "error");
              processed++;
              showProgress(processed, total, file.name);
              continue;
            }

            let img;
            try {
              img = await loadImage(URL.createObjectURL(readableBlob));
            } catch (imgErr) {
              console.error(
                `Skipping ${file.name}: could not load image ‚Äî`,
                imgErr,
              );
              showToast(`Could not load ${file.name} ‚Äî skipped.`, "error");
              processed++;
              showProgress(processed, total, file.name);
              continue;
            }

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            canvas.width = img.width + sidePad * 2;
            canvas.height = img.height + topPad + bottomPad;

            // White background
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw original image (no crop, no scale)
            ctx.drawImage(img, sidePad, topPad);

            // Top-left text
            if (text) {
              ctx.fillStyle = "#000";
              ctx.font = "bold 36px sans-serif";
              ctx.textBaseline = "middle";
              ctx.fillText(text, sidePad, topPad / 2);
            }

            // Logos (top-right)
            const logoHeight = topPad - 60;
            const gap = 24;

            const l1w = logoHeight * (logo1.width / logo1.height);
            const l2w = logoHeight * (logo2.width / logo2.height);

            const totalWidth = l1w + l2w + gap;

            let x = canvas.width - totalWidth - sidePad;
            const y = 30;

            ctx.drawImage(logo1, x, y, l1w, logoHeight);
            x += l1w + gap;
            ctx.drawImage(logo2, x, y, l2w, logoHeight);

            // Export PNG
            const blob = await new Promise((resolve) =>
              canvas.toBlob(resolve, "image/png"),
            );

            zip.file(
              `watermarked-${file.name.replace(/\.[^/.]+$/, "")}.png`,
              blob,
            );

            processed++;
            showProgress(processed, total, file.name);

            // Yield to UI thread so progress actually renders
            await new Promise((r) => setTimeout(r, 30));
          }

          // Download ZIP
          document.getElementById("progressDetail").textContent =
            "Generating ZIP file‚Ä¶";
          const zipBlob = await zip.generateAsync({ type: "blob" });
          download(zipBlob, "watermarked-images.zip");

          showToast(
            `Done! ${total} image${total > 1 ? "s" : ""} watermarked & downloaded.`,
            "success",
          );
        } catch (err) {
          console.error(err);
          showToast("Something went wrong: " + err.message, "error");
        } finally {
          setLoading(false);
        }
      }

      /**
       * Convert a File to a browser-readable Blob.
       * Handles HEIC/HEIF (iPhone), and falls back for other exotic types.
       */
      async function toReadableBlob(file) {
        const name = file.name.toLowerCase();
        const type = file.type.toLowerCase();

        // Check both extension and MIME type for HEIC/HEIF
        const isHEIC =
          name.endsWith(".heic") ||
          name.endsWith(".heif") ||
          type === "image/heic" ||
          type === "image/heif";

        if (isHEIC) {
          console.log(`Converting HEIC/HEIF file: ${file.name}`);

          // Wait for heic2any to load if not ready yet
          if (window.heic2anyLoaded) {
            await window.heic2anyLoaded;
          }

          if (!window.heic2any) {
            throw new Error(
              "HEIC converter not loaded. Please refresh and try again.",
            );
          }

          try {
            // Convert HEIC/HEIF ‚Üí PNG (lossless) for maximum quality
            const convertedBlob = await heic2any({
              blob: file,
              toType: "image/png",
              quality: 1, // Maximum quality (lossless)
            });

            // heic2any may return an array of blobs or a single blob
            const result = Array.isArray(convertedBlob)
              ? convertedBlob[0]
              : convertedBlob;
            console.log(
              `Successfully converted ${file.name} to PNG (lossless)`,
            );
            return result;
          } catch (err) {
            console.error(`HEIC conversion failed for ${file.name}:`, err);
            throw new Error(
              `Failed to convert HEIC file. Please try using Chrome or Edge browser, or convert the file to JPEG first.`,
            );
          }
        }

        // For all other formats, the browser will attempt to decode natively.
        return file;
      }

      function loadImage(src) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = src;
        });
      }

      function download(blob, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
      }
    </script>
  </body>
</html>
